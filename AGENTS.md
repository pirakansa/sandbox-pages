# AGENTS.md

このファイルは **AI コーディングエージェント向け README** です。人間向けの README.md を補完し、エージェントが安全かつ効率的に開発作業を行えるようにします。

---

## 1. セットアップ手順

* Rust ツールチェーン: `rustup default stable`
* 必要パッケージ: `sudo apt-get install build-essential`
* 開発補助: `make`

---

## 2. ビルド・実行方法

* ビルド: `cargo build --locked`
* テスト実行: `cargo test --all`
* 静的解析: `cargo fmt --all -- --check && cargo clippy -- -D warnings`

---

## 3. プロジェクト構成

**Rust 公式の Package Layout** に準拠した、単体アプリ（ライブラリ共存型）の基本形を採用します。

```
.
├─ Cargo.toml
├─ Cargo.lock               # CI では生成されるため管理対象外でも可（方針に従う）
├─ src/
│  ├─ main.rs              # エントリポイント（実行バイナリ）
│  ├─ lib.rs               # 共有ロジック（テストしやすい）
│  ├─ config.rs            # 設定読み込み（figment/serde 等）
│  ├─ telemetry.rs         # ロギング / トレース（tracing）
│  └─ domain/              # ドメイン層（必要に応じて）
│     ├─ mod.rs
│     └─ service.rs
├─ src/bin/                # 追加バイナリ（CLI ツール等、任意）
│  ├─ tool-a.rs
│  └─ tool-b.rs
├─ examples/               # 使い方サンプル（任意）
├─ tests/                  # 統合テスト（`cargo test` で実行）
├─ benches/                # ベンチマーク（criterion 等、任意）
├─ ci/                     # CI ワークフロー・補助スクリプト
└─ docs/                   # ドキュメント
```

### 役割と方針

* ` に共通処理を集約し、` は起動・DI・引数処理に限定します。
* 追加のコマンドラインツールは \`\` に配置し、1 ファイル = 1 バイナリ。
* 統合テストは \`\` に置き、公開 API 経由で振る舞いを確認。
* サンプルがあると理解が速い場合のみ \`\` を使用（増やしすぎない）。
* ベンチは必要時のみ \`\` を使用し、CI 負荷と相談して実行可否を決める。

### エージェント向けルール

* 新規ファイルを作成する場合は、上記ディレクトリ内に配置すること。
* 共通ロジックは `lib.rs`/`src/<module>.rs` 側へ寄せ、`main.rs` にビジネスロジックを書かない。
* 追加バイナリが必要な場合は `src/bin/<name>.rs` を作成し、README/AGENTS.md に目的を 1 行で追記する。

---

## 4. コード規約

* Rust: `clippy` 警告ゼロ、`thiserror` によるエラー型、`anyhow` はバイナリのみ
* 命名規則: モジュールは snake\_case、型は UpperCamelCase
* コミット: Conventional Commits + 変更点をファイル単位で列挙（本文は日本語）
* 本ガイドの範囲にある変更は必ず規約に従うこと。
* 無関係な大規模リファクタは避け、影響範囲を最小化すること。

---

## 5. テストと検証

* 単体テスト: `cargo test --all`
* セキュリティ: `cargo audit` 実行必須、SPDX ライセンスヘッダ必須

---

## 6. CI 要件

* PR は以下を必ず通過すること

  * build
  * test
  * fmt
  * clippy
  * audit

---

## 7. 安全性・データ取り扱い

* 機密情報やシークレットはコミットしない
* ログに含まれるメールやユーザー名は必ずマスク
* 個人情報・機微データはリポジトリ外へ持ち出さない
* 機密データをログに出力することを禁止する

---

## 8. エージェント向け補足

* 同一リポジトリに複数の AGENTS.md がある場合、編集対象に最も近いものを参照
* 指示が競合する場合、ユーザの明示的なプロンプトを優先
* エージェントは作業前に **テスト・ビルドコマンドを実行可能**

---

## 9. ブランチ運用（GitHub フロー）

このプロジェクトは **GitHub フロー** に従います。`main` を基点としたシンプルな運用を行います。

* **main ブランチ**: 常にデプロイ可能な状態を維持。直接コミットは禁止し、必ず Pull Request（PR）を経由します。
* **フィーチャーブランチ (**\`\`**)**: 新機能や修正は `main` から派生させ、作業後に PR を作成します。
* **ホットフィックスブランチ (**\`\`**)**: 緊急修正は `main` から派生させ、CI 合格後すぐにマージ可能です。

### ルール

* 新規ブランチは必ず `main` を基点に作成すること。
* PR 作成時にはレビュアを指定し、CI が通ってからマージすること。
* マージ後は不要になったブランチを削除して構いません。

---

## 10. コミットメッセージ運用

このプロジェクトのコミットメッセージは **Conventional Commits** に従います。エージェントも必ずこのルールを守ってください。コメント部分（説明や本文）は **日本語で記述** します。

### フォーマット

```
type(scope?): 説明
```

* `type`: feat / fix / docs / style / refactor / test / chore
* `scope`: 任意。対象モジュールやディレクトリ名など。
* `説明`: 簡潔に変更点を日本語で記述。

### 本文

* WHY（変更理由）を1文で日本語で記載。
* HOW（変更内容）をファイル単位で日本語で列挙。

```
- src/lib.rs: 設定ロード処理を最適化
- docs/setup.md: 初期セットアップ手順を更新
```

### 粒度

* 1コミット = 1意味的変更。
* 自動生成コードも論理単位ごとに分割すること。

### PR とコミットの関係

* PR 説明欄には **動機 / 設計 / テスト / リスク** を必須で日本語記載。
* レビュー後に squash するかどうかはチーム方針に従う。

---

## 11. ドキュメント運用

* **README.md (トップレベル)**:

  * 前半: プロジェクトの生成物（ツール等）の概要、インストール方法、基本的な使い方。
  * 後半: プロジェクト開発の概要、ビルド方法、開発者向けの利用方法。
  * 目的: 初めて利用する人でもハードルを感じず導入できるようにする。

* **docs/**:

  * README に収まりきらない詳細なドキュメントを分類して配置する。
  * 設計方針、API 詳細、補足チュートリアルなど、探しやすいようにファイルを分ける。
  * 初めて使う人が「もっと詳しく知りたい」と思った時に迷わず参照できることを目的とする。

* **運用ルール**:

  * PR を作成する際には、コード変更に対応するドキュメント修正を必ず含めること。
  * ドキュメント更新が不要な場合でも「変更なし」である旨を PR 説明欄に明記すること。
  * ドキュメント内のサンプルコードや例は常に実コードと一致させること。
  * 自動生成部分（例: API リファレンス）はスクリプトで更新し、PR に含めること。

## 12. 依存管理ポリシー

* 依存追加は `cargo add <crate>` を利用し、Cargo.toml を直接編集しない。
* バージョン指定は SemVer を基本とし、必要がない限りワイルドカードは使わない。
* 依存更新は `cargo update -p <crate>` 単位で行い、PR ごとに限定する。
* PR 作成時に `cargo audit` を実行し、脆弱性がないことを確認する。
* **dev-dependencies**: テストや開発補助に限定。不要になったら削除すること。
* **build-dependencies**: ビルド時に必須なもののみに限定。依存が大きくなる場合は理由を明記すること。

---

## 13. リリース運用

* バージョニングは **SemVer** に従う。
* 新バージョンリリース時は Git タグを付与する。
* CHANGELOG.md を更新する。自動生成ツールを使う場合は PR に含める。

### 13.1 CHANGELOG.md ポリシー

* **形式**: \[Keep a Changelog 方式] に準拠したセクション分割。

  * `## [Unreleased]`（未リリース差分）
  * `## [X.Y.Z] - YYYY-MM-DD`
  * 小見出し: `Added / Changed / Fixed / Deprecated / Removed / Security`
* **記述言語**: 日本語。必要に応じて短い英語補足は可。
* **書き方の原則**:

  * ユーザー視点で「何が変わるか」を一文で。内部実装詳細は過度に書かない。
  * 破壊的変更は **Bold** で強調し、移行手順があればリンクを付与。
  * 可能なら PR/Issue 番号を付記（例: `(#123)`）。
* **運用フロー**:

  1. 変更が `main` へ入る PR に、まず `Unreleased` に項目を追加。
  2. リリース PR で `Unreleased` を `X.Y.Z - YYYY-MM-DD` にリネームし、必要に応じて整理。
  3. Git タグ `vX.Y.Z` を作成し、リリースノートへ CHANGELOG 該当部分を転記。
* **Conventional Commits との対応（目安）**:

  * `feat`: `Added` / `Changed`
  * `fix`: `Fixed`
  * `docs`: `Changed`
  * `refactor`/`perf`/`style`: `Changed`
  * `test`/`chore`: 記載は任意（ユーザー影響があれば記載）
  * `BREAKING CHANGE:` を含む場合は、当該項を太字で強調し、移行ガイドを用意。
* **リンク運用（任意だが推奨）**:

  * ファイル末尾に比較リンクを設置：

    ```
    [Unreleased]: https://example.com/compare/vX.Y.Z...HEAD
    [1.2.3]: https://example.com/compare/v1.2.2...v1.2.3
    ```
* **ツール**（任意）:

  * `git-cliff` / `conventional-changelog` などで素案を生成→手で要約を整える。

---

## 14. PR テンプレート

PR 作成時には以下の項目を記載すること。

* **動機**: なぜこの変更が必要か
* **設計**: どのような方針で実装したか
* **テスト**: どのテストで確認したか
* **リスク**: 想定される副作用や懸念点

テンプレート例:

```
### 動機
...

### 設計
...

### テスト
...

### リスク
...
```

---

## 15. チェックリスト

*